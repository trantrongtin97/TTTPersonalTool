@inherits EditBaseComponent
@typeparam TItem

@if (ShowConfirmation)
{
    <div class="modal fade show d-block" tabindex="-1" role="dialog" id="confirmSaveModal">
        <div class="modal-dialog" role="document">
            @{
                if (Target != null)
                {
                    <EditForm Model="@Target" OnValidSubmit="@ValidSubmit" OnInvalidSubmit="InvalidSubmit">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="confirmSaveModalLabel">
                                    @if (!IsNewForm) @EditTitle else @CreateTitle
                                </h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close" @onclick="() => OnConfirmationChange(false)">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">

                                <div class="form-group">
                                    <DataAnnotationsValidator />
                                    @CreateComponent()
                                </div>
                                
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal" @onclick="() => OnConfirmationChange(false)">@MsgBtnCancel</button>
                                <button type="submit" class="btn btn-danger" data-dismiss="modal">@MsgBtnSave</button>
                            </div>
                        </div>
                    </EditForm>
                }
            }
        </div>
    </div>
}

@code {
    private bool IsNewForm { get; set; }
    private TItem? Target { get; set; }

    public async Task LoadObj(object value)
    {
        if (value is not null)
        {
            Target = (TItem)value;
            IsNewForm = false;
        }
        else
        {
            Target = Activator.CreateInstance<TItem>();
            IsNewForm = true;
        }
    }

    [Parameter]
    public EventCallback<object> ObjectChange { get; set; }

    public async Task ValidSubmit()
    {
        ShowConfirmation = false;
        var a = Target;
        await ObjectChange.InvokeAsync(Target);
    }

    public async Task InvalidSubmit()
    {
        var a = Target;
    }

    private List<DataLookUp> ParseToLsDataLU(object? obj)
    {
        return new List<DataLookUp>((IEnumerable<DataLookUp>)obj);
    }

    private List<string> ParseToLsStringLU(object? obj)
    {
        return new List<string>((IEnumerable<string>)obj);
    }

    public RenderFragment CreateComponent() => builder =>
    {
        var proList = typeof(TItem).GetProperties();
        Dictionary<string, object?> dicDataLU = new Dictionary<string, object?>();
        foreach (var prp in proList)
        {
            foreach (var p in proList.Where(t => t.Name.EndsWith("LookUp")))
            {
                var dataLookUp = (DataLookUpAttribute)p.GetCustomAttributes(typeof(DataLookUpAttribute), false)?.First();
                if (dataLookUp.TargetProperty == prp.Name)
                {
                    var propInfoLU = typeof(TItem).GetProperty(p.Name);
                    var propInfoLUValue = propInfoLU.GetValue(Target);
                    if (propInfoLUValue is IEnumerable<DataLookUp>)
                    {
                        dicDataLU[dataLookUp.TargetProperty] = ParseToLsDataLU(propInfoLUValue);
                    }
                    if (propInfoLUValue is IEnumerable<string>)
                    {
                        dicDataLU[dataLookUp.TargetProperty] = ParseToLsStringLU(propInfoLUValue);
                    }
                }
            }
            if (prp.Name.EndsWith("LookUp")) continue;
            Type T = prp.GetType();
            if (prp.GetCustomAttributes(typeof(TTTDataTypeAttribute), true).Length != 0)
            {
                var attrList = (TTTDataTypeAttribute)prp.GetCustomAttributes(typeof(TTTDataTypeAttribute), false).First();
                var displayLabel = (DisplayAttribute)prp.GetCustomAttributes(typeof(DisplayAttribute), false).First();

                // Get the initial property value.
                var propInfoValue = typeof(TItem).GetProperty(prp.Name);

                // Create an expression to set the ValueExpression-attribute.
                var constant = System.Linq.Expressions.Expression.Constant(Target, typeof(TItem));
                var exp = System.Linq.Expressions.MemberExpression.Property(constant, prp.Name);
                switch (attrList.DataType)
                {
                    case TTTDataType.Text:
                    case TTTDataType.EmailAddress:
                    case TTTDataType.PhoneNumber:
                    case TTTDataType.MultilineText:
                        {
                            builder.OpenComponent(0, typeof(TTT.Framework.Component.AutoFormComponents.InputText));
                            // Create the handler for ValueChanged.
                            builder.AddAttribute(3, "ValueChanged", Microsoft.AspNetCore.Components.CompilerServices.RuntimeHelpers.TypeCheck<Microsoft.AspNetCore.Components.EventCallback<System.String>>(Microsoft.AspNetCore.Components.EventCallback.Factory.Create<System.String>(this, Microsoft.AspNetCore.Components.EventCallback.Factory.CreateInferred(this, __value => propInfoValue.SetValue(Target, __value), (string)propInfoValue.GetValue(Target)))));
                            builder.AddAttribute(4, "ValueExpression", System.Linq.Expressions.Expression.Lambda<Func<string>>(exp));
                            if (attrList.DataType == TTTDataType.MultilineText)
                                builder.AddAttribute(6, "Multiline", true);
                            break;
                        }
                    case TTTDataType.Double:
                    case TTTDataType.Currency:
                        builder.OpenComponent(0, typeof(TTT.Framework.Component.AutoFormComponents.InputDouble));
                        builder.AddAttribute(3, "ValueChanged", Microsoft.AspNetCore.Components.CompilerServices.RuntimeHelpers.TypeCheck<Microsoft.AspNetCore.Components.EventCallback<double?>>(Microsoft.AspNetCore.Components.EventCallback.Factory.Create<double?>(this, Microsoft.AspNetCore.Components.EventCallback.Factory.CreateInferred(this, __value => propInfoValue.SetValue(Target, __value), (double?)propInfoValue.GetValue(Target)))));
                        builder.AddAttribute(4, "ValueExpression", System.Linq.Expressions.Expression.Lambda<Func<double?>>(exp));
                        break;
                    case TTTDataType.Date:
                        builder.OpenComponent(0, typeof(TTT.Framework.Component.AutoFormComponents.InputDate));
                        builder.AddAttribute(3, "ValueChanged", Microsoft.AspNetCore.Components.CompilerServices.RuntimeHelpers.TypeCheck<Microsoft.AspNetCore.Components.EventCallback<DateTime?>>(Microsoft.AspNetCore.Components.EventCallback.Factory.Create<DateTime?>(this, Microsoft.AspNetCore.Components.EventCallback.Factory.CreateInferred(this, __value => propInfoValue.SetValue(Target, __value), (DateTime?)propInfoValue.GetValue(Target)))));
                        builder.AddAttribute(4, "ValueExpression", System.Linq.Expressions.Expression.Lambda<Func<DateTime?>>(exp));
                        break;
                    case TTTDataType.Time:
                        builder.OpenComponent(0, typeof(TTT.Framework.Component.AutoFormComponents.InputTime));
                        builder.AddAttribute(3, "ValueChanged", Microsoft.AspNetCore.Components.CompilerServices.RuntimeHelpers.TypeCheck<Microsoft.AspNetCore.Components.EventCallback<DateTime?>>(Microsoft.AspNetCore.Components.EventCallback.Factory.Create<DateTime?>(this, Microsoft.AspNetCore.Components.EventCallback.Factory.CreateInferred(this, __value => propInfoValue.SetValue(Target, __value), (DateTime?)propInfoValue.GetValue(Target)))));
                        builder.AddAttribute(4, "ValueExpression", System.Linq.Expressions.Expression.Lambda<Func<DateTime?>>(exp));
                        break;
                    case TTTDataType.DateTime:
                        builder.OpenComponent(0, typeof(TTT.Framework.Component.AutoFormComponents.InputDateTime));
                        builder.AddAttribute(3, "ValueChanged", Microsoft.AspNetCore.Components.CompilerServices.RuntimeHelpers.TypeCheck<Microsoft.AspNetCore.Components.EventCallback<DateTime?>>(Microsoft.AspNetCore.Components.EventCallback.Factory.Create<DateTime?>(this, Microsoft.AspNetCore.Components.EventCallback.Factory.CreateInferred(this, __value => propInfoValue.SetValue(Target, __value), (DateTime?)propInfoValue.GetValue(Target)))));
                        builder.AddAttribute(4, "ValueExpression", System.Linq.Expressions.Expression.Lambda<Func<DateTime?>>(exp));
                        break;
                    case TTTDataType.Combobox:
                        builder.OpenComponent(0, typeof(TTT.Framework.Component.AutoFormComponents.Selection));
                        builder.AddAttribute(3, "ValueChanged", Microsoft.AspNetCore.Components.CompilerServices.RuntimeHelpers.TypeCheck<Microsoft.AspNetCore.Components.EventCallback<int?>>(Microsoft.AspNetCore.Components.EventCallback.Factory.Create<int?>(this, Microsoft.AspNetCore.Components.EventCallback.Factory.CreateInferred(this, __value => propInfoValue.SetValue(Target, __value), (int?)propInfoValue.GetValue(Target)))));
                        builder.AddAttribute(1, "Data", dicDataLU[prp.Name]);
                        builder.AddAttribute(4, "ValueExpression", System.Linq.Expressions.Expression.Lambda<Func<int?>>(exp));
                        break;
                    case TTTDataType.Dropdowlist:
                        builder.OpenComponent(0, typeof(TTT.Framework.Component.AutoFormComponents.Dropdowlist));
                        builder.AddAttribute(3, "ValueChanged", Microsoft.AspNetCore.Components.CompilerServices.RuntimeHelpers.TypeCheck<Microsoft.AspNetCore.Components.EventCallback<string>>(Microsoft.AspNetCore.Components.EventCallback.Factory.Create<string>(this, Microsoft.AspNetCore.Components.EventCallback.Factory.CreateInferred(this, __value => propInfoValue.SetValue(Target, __value), (string)propInfoValue.GetValue(Target)))));
                        builder.AddAttribute(1, "Data", new List<string>());
                        builder.AddAttribute(4, "ValueExpression", System.Linq.Expressions.Expression.Lambda<Func<string>>(exp));
                        break;
                    case TTTDataType.CheckBox:
                        builder.OpenComponent(0, typeof(TTT.Framework.Component.AutoFormComponents.CheckBox));
                        builder.AddAttribute(3, "ValueChanged", Microsoft.AspNetCore.Components.CompilerServices.RuntimeHelpers.TypeCheck<Microsoft.AspNetCore.Components.EventCallback<bool>>(Microsoft.AspNetCore.Components.EventCallback.Factory.Create<bool>(this, Microsoft.AspNetCore.Components.EventCallback.Factory.CreateInferred(this, __value => propInfoValue.SetValue(Target, __value), (bool)propInfoValue.GetValue(Target)))));
                        builder.AddAttribute(4, "ValueExpression", System.Linq.Expressions.Expression.Lambda<Func<bool>>(exp));
                        break;
                    default:
                        break;
                }
                var defaultValue = propInfoValue.GetValue(Target);
                builder.AddAttribute(1, "Value", defaultValue);
                builder.AddAttribute(7, "DisplayName", displayLabel.Name);
                // builder.AddAttribute(6, "FloatLabelType", FloatLabelType.Auto);

                builder.CloseComponent();
            }
        }
    };

}
               